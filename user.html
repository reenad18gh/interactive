<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>User</title>
<style>
  :root{ --primary:#ff6f00; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  body{margin:0;background:#0f1115;color:#e7e7e7;font-family:var(--font)}
  .wrap{max-width:1100px;margin:16px auto;padding:0 16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
  .btn{background:var(--primary);color:#111;border:none;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
  .input{background:#181a20;color:#e7e7e7;border:1px solid #333;border-radius:8px;padding:8px 10px}
  .board{position:relative;border:1px dashed #333;border-radius:8px;overflow:hidden;touch-action:none;background:#111}
  canvas{display:block;width:100%;height:520px;touch-action:none;cursor:crosshair}
</style>
</head>
<body>
<div class="wrap">
  <h1>User Screen</h1>

  <div class="toolbar">
    <label>Color <input id="color" type="color" class="input" value="#ffffff"></label>
    <label>Size <input id="size" type="range" class="input" min="2" max="30" value="6"></label>
    <button class="btn" id="clearBtn">Clear</button>
    <button class="btn" id="sendBtn">Send to Display</button>
  </div>

  <div class="board">
    <canvas id="pad"></canvas>
  </div>
</div>

<script src="settings.js"></script>
<script>
  applySettings();

  // Canvas setup
  const canvas = document.getElementById('pad');
  const ctx = canvas.getContext('2d');
  const color = document.getElementById('color');
  const size  = document.getElementById('size');
  const clearBtn = document.getElementById('clearBtn');
  const sendBtn  = document.getElementById('sendBtn');

  // Resize canvas to actual pixels
  function fit(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width  = Math.floor(rect.width * dpr);
    canvas.height = Math.floor(rect.height * dpr);
    ctx.scale(dpr, dpr);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.fillStyle = '#111';
    ctx.fillRect(0,0,rect.width,rect.height);
  }
  window.addEventListener('resize', fit);
  fit();

  let drawing = false, lastX=0, lastY=0;

  function pos(e){
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX ?? e.touches?.[0].clientX) - r.left;
    const y = (e.clientY ?? e.touches?.[0].clientY) - r.top;
    return {x,y};
  }

  function down(e){
    e.preventDefault();
    drawing = true;
    const p = pos(e);
    lastX = p.x; lastY = p.y;
  }
  function move(e){
    if(!drawing) return;
    e.preventDefault();
    const p = pos(e);
    ctx.strokeStyle = color.value;
    ctx.lineWidth = Number(size.value);
    ctx.beginPath();
    ctx.moveTo(lastX,lastY);
    ctx.lineTo(p.x,p.y);
    ctx.stroke();
    lastX = p.x; lastY = p.y;
  }
  function up(e){ drawing = false; }

  canvas.addEventListener('pointerdown', down);
  canvas.addEventListener('pointermove', move);
  canvas.addEventListener('pointerup',   up);
  canvas.addEventListener('pointercancel', up);
  canvas.addEventListener('touchstart', down, {passive:false});
  canvas.addEventListener('touchmove',  move, {passive:false});
  canvas.addEventListener('touchend',   up);

  clearBtn.onclick = ()=>{ fit(); };

  // Send to display via BroadcastChannel
  const ch = new BroadcastChannel('interactive-wall');
  sendBtn.onclick = ()=>{
    // نرسل صورة PNG مضغوطة
    const data = canvas.toDataURL('image/png');
    ch.postMessage({type:'image', data});
  };
</script>
</body>
</html>
